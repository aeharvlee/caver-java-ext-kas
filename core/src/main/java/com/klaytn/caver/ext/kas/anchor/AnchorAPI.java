package com.klaytn.caver.ext.kas.anchor;

import com.squareup.okhttp.Call;
import io.swagger.client.ApiCallback;
import io.swagger.client.ApiClient;
import io.swagger.client.ApiException;
import io.swagger.client.api.anchor.v1.api.DataAnchoringTransactionApi;
import io.swagger.client.api.anchor.v1.api.OperatorApi;
import io.swagger.client.api.anchor.v1.model.*;


import java.security.InvalidParameterException;
import java.util.Map;

/**
 * Representing an wrapping class tha connects Anchor APi.
 */
public class AnchorAPI {

    /**
     * Anchor API rest-client object.
     */
    DataAnchoringTransactionApi dataAnchoringTransactionApi;

    /**
     * Operator API rest-client object.
     */
    OperatorApi operatorApi;

    /**
     * Klaytn network id.
     */
    String chainId;

    /**
     * Creates an AnchorAPI instance
     * @param chainId A Klaytn network chain id.
     * @param anchorApiClient The Api client for connecting with KAS.
     */
    public AnchorAPI(String chainId, ApiClient anchorApiClient) {
        setChainId(chainId);
        setDataAnchoringTransactionApi(new DataAnchoringTransactionApi(anchorApiClient));
        setOperatorApi(new OperatorApi(anchorApiClient));
    }

    /**
     * Sends ChainDataAnchoring transaction to the Klaytn.
     * POST /v1/anchor
     * @param operatorId Operator address to send transaction.
     * @param payload Data to be anchored to the Klaytn.
     * @return AnchorBlockResponse
     * @throws ApiException
     */
    public AnchorBlockResponse sendAnchoringData(String operatorId, Map payload) throws ApiException {
        checkPayload(payload);

        AnchorBlockRequest anchorRequest = new AnchorBlockRequest();
        anchorRequest.setOperator(operatorId);
        anchorRequest.setPayload(payload);

        return getDataAnchoringTransactionApi().anchorBlock(getChainId(), anchorRequest);
    }

    /**
     * Sends ChainDataAnchoring transaction to the Klaytn asynchronously.
     * POST /v1/anchor
     * @param operatorId Operator address to send transaction.
     * @param payload Data to be anchored to the Klaytn.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call sendAnchoringDataAsync(String operatorId, Map payload, ApiCallback<AnchorBlockResponse> callback) throws ApiException {
        checkPayload(payload);

        AnchorBlockRequest anchorRequest = new AnchorBlockRequest();
        anchorRequest.setOperator(operatorId);
        anchorRequest.setPayload(payload);

        return getDataAnchoringTransactionApi().anchorBlockAsync(getChainId(), anchorRequest, callback);
    }

    /**
     * Gets anchoring transaction list generated by a given operator.
     * GET /v1/operator/{operator_id}/tx
     * @param operatorId An operator address to query the anchoring transaction list.
     * @return RetrieveAnchorBlockResponse
     * @throws ApiException
     */
    public RetrieveAnchorBlockResponse getAnchoringTransactions(String operatorId) throws ApiException {
        AnchorQueryOptions params = new AnchorQueryOptions();
        return getAnchoringTransactions(operatorId, params);
    }

    /**
     * Gets anchoring transaction list generated by a given operator.
     * GET /v1/operator/{operator_id}/tx
     * @param operatorId An operator address to query the anchoring transaction list.
     * @param queryParams An query options object.
     * @return RetrieveAnchorBlockResponse
     * @throws ApiException
     */
    public RetrieveAnchorBlockResponse getAnchoringTransactions(String operatorId, AnchorQueryOptions queryParams) throws ApiException {
        return dataAnchoringTransactionApi.retirieveAnchorBlock(getChainId(), operatorId, queryParams.getSize(), queryParams.getCursor() , queryParams.getFromDate(), queryParams.getToDate());
    }

    /**
     * Gets anchoring transaction list generated by a given operator asynchronously.
     * GET /v1/operator/{operator_id}/tx
     * @param operatorId An operator address to query the anchoring transaction list.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getAnchoringTransactionsAsync(String operatorId, ApiCallback<RetrieveAnchorBlockResponse> callback) throws ApiException {
        AnchorQueryOptions params = new AnchorQueryOptions();
        return getAnchoringTransactionsAsync(operatorId, params, callback);
    }

    /**
     * Gets anchoring transaction list generated by a given operator asynchronously.
     * GET /v1/operator/{operator_id}/tx
     * @param operatorId An operator address to query the anchoring transaction list.
     * @param queryParams A query options object.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getAnchoringTransactionsAsync(String operatorId, AnchorQueryOptions queryParams, ApiCallback<RetrieveAnchorBlockResponse> callback) throws ApiException {
        return dataAnchoringTransactionApi.retirieveAnchorBlockAsync(getChainId(), operatorId, queryParams.getSize(), queryParams.getCursor() , queryParams.getFromDate(), queryParams.getToDate(), callback);
    }

    /**
     * Get anchoring transaction with the given transaction hash.
     * GET /v1/operator/{operator_id}/tx/{tx_hash}
     * @param operatorId An operator address to query the anchoring transaction.
     * @param txHash A transaction hash used for getting anchoring transaction.
     * @return GetAnchorBlockByTxResponse
     * @throws ApiException
     */
    public GetAnchorBlockByTxResponse getAnchoringTransactionByTxHash(String operatorId, String txHash) throws ApiException {
        return dataAnchoringTransactionApi.getAnchorBlockByTx(getChainId(), operatorId, txHash);
    }

    /**
     * Get anchoring transaction with the given transaction hash asynchronously.
     * GET /v1/operator/{operator_id}/tx/{tx_hash}
     * @param operatorId An operator address to query the anchoring transaction.
     * @param txHash A transaction hash used for getting anchoring transaction.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getAnchoringTransactionByTxHashAsync(String operatorId, String txHash, ApiCallback<GetAnchorBlockByTxResponse> callback) throws ApiException {
        return dataAnchoringTransactionApi.getAnchorBlockByTxAsync(getChainId(), operatorId, txHash, callback);
    }

    /**
     * Get anchoring transaction with the given payload id.
     * GET /v1/operator/{operator_id}/payload/{payload_id}
     * @param operatorId An operator address to query the anchoring transaction.
     * @param payloadId A payload id used for getting anchoring transaction.
     * @return GetAnchorBlockByPayloadIDResponse
     * @throws ApiException
     */
    public GetAnchorBlockByPayloadIDResponse getAnchoringTransactionByPayloadId(String operatorId, String payloadId) throws ApiException {
        return dataAnchoringTransactionApi.getAnchorBlockByPayloadID(getChainId(), operatorId, payloadId);
    }

    /**
     * Get anchoring transaction with the given payload id asynchronously.
     * GET /v1/operator/{operator_id}/payload/{payload_id}
     * @param operatorId An operator address to query the anchoring transaction.
     * @param payloadId A payload id used for getting anchoring transaction.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getAnchoringTransactionByPayloadIdAsync(String operatorId, String payloadId, ApiCallback<GetAnchorBlockByPayloadIDResponse> callback) throws ApiException {
        return dataAnchoringTransactionApi.getAnchorBlockByPayloadIDAsync(getChainId(), operatorId, payloadId, callback);
    }

    /**
     * Get operator list.
     * GET /v1/operator
     * @return RetrieveOperatorsResponse
     * @throws ApiException
     */
    public RetrieveOperatorsResponse getOperators() throws ApiException {
        AnchorQueryOptions queryParams = new AnchorQueryOptions();
        return getOperators(queryParams);
    }

    /**
     * Get operator list.
     * GET /v1/operator
     * @param queryParams A query options object.
     * @return RetrieveOperatorsResponse
     * @throws ApiException
     */
    public RetrieveOperatorsResponse getOperators(AnchorQueryOptions queryParams) throws ApiException {
        return getOperatorApi().retrieveOperators(getChainId(), queryParams.getSize(), queryParams.getCursor(), queryParams.getFromDate(), queryParams.toDate);
    }

    /**
     * Get operator list asynchronously.
     * GET /v1/operator
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getOperatorsAsync(ApiCallback<RetrieveOperatorsResponse> callback) throws ApiException {
        AnchorQueryOptions queryParams = new AnchorQueryOptions();
        return getOperatorsAsync(queryParams, callback);
    }

    /**
     * Get operator list asynchronously.
     * GET /v1/operator
     * @param queryParams A query options object.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getOperatorsAsync(AnchorQueryOptions queryParams, ApiCallback<RetrieveOperatorsResponse> callback) throws ApiException {
        return getOperatorApi().retrieveOperatorsAsync(getChainId(), queryParams.getSize(), queryParams.getCursor(), queryParams.getFromDate(), queryParams.getToDate(), callback);
    }

    /**
     * Get operator information.
     * GET /v1/operator/{operator_id}
     * @param operatorId An operator address.
     * @return GetOperatorResponse
     * @throws ApiException
     */
    public GetOperatorResponse getOperator(String operatorId) throws ApiException {
        return getOperatorApi().getOperator(chainId, operatorId);
    }

    /**
     * Get operator information asynchronously.
     * GET /v1/operator/{operator_id}
     * @param operatorId An operator address.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getOperatorAsync(String operatorId, ApiCallback<GetOperatorResponse> callback) throws ApiException {
        return getOperatorApi().getOperatorAsync(chainId, operatorId, callback);
    }

    /**
     * Getter function for dataAnchoringTransactionApi.
     * @return DataAnchoringTransactionApi
     */
    public DataAnchoringTransactionApi getDataAnchoringTransactionApi() {
        return dataAnchoringTransactionApi;
    }

    /**
     * Getter function for operatorApi.
     * @return OperatorApi
     */
    public OperatorApi getOperatorApi() {
        return operatorApi;
    }

    /**
     * Getter function for chain id.
     * @return String
     */
    public String getChainId() {
        return chainId;
    }

    /**
     * Setter function for dataAnchoringTransactionApi
     * @param dataAnchoringTransactionApi An rest-client related Anchor API.
     */
    public void setDataAnchoringTransactionApi(DataAnchoringTransactionApi dataAnchoringTransactionApi) {
        this.dataAnchoringTransactionApi = dataAnchoringTransactionApi;
    }

    /**
     * Setter function for operatorApi
     * @param operatorApi An rest-client related Operator API.
     */
    public void setOperatorApi(OperatorApi operatorApi) {
        this.operatorApi = operatorApi;
    }

    /**
     * Setter function for chain id
     * @param chainId The klaytn network chain id.
     */
    public void setChainId(String chainId) {
        this.chainId = chainId;
    }

    private void checkPayload(Map payload) {
        if(payload.get("id") == null) throw new NullPointerException("Payload must have an 'id' of String type.");
        if(!(payload.get("id") instanceof String)) throw new InvalidParameterException("Payload id must be String type.");
    }

}
